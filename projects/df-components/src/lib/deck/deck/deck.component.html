<ng-template #editCard let-card>
  <form [formGroup]="cardForm" (ngSubmit)="handleSubmit(card)">
    <div class="df-card__title {{ card?.colour }}">
      <h2 class="df-card__title-text">{{ card?.title }}</h2>
    </div>
    <div class="df-card__title">
      <mdc-form-field fluid>
        <mdc-text-field
          label="Title"
          formControlName="title"
          required
        ></mdc-text-field>
      </mdc-form-field>
    </div>
    <div class="df-card__title">
      <mdc-form-field fluid>
        <mdc-text-field
          label="Size"
          formControlName="size"
          type="number"
          required
        ></mdc-text-field>
      </mdc-form-field>
    </div>
    <div class="df-card__title">
      <mdc-form-field fluid>
        <mdc-text-field
          label="Sort Order"
          formControlName="sortOrder"
          type="number"
        ></mdc-text-field>
      </mdc-form-field>
    </div>

    <div class="df-card__supporting-text df-card--border deck-color-selector">
      <mdc-form-field fluid>
        <ng-select
          appendTo="body"
          [items]="cardTypes"
          placeholder="Card Type"
          required
          formControlName="cardType"
        >
          <ng-template
            ng-option-tmp
            let-item="item"
            let-index="index"
            let-search="searchTerm"
          >
            <h5 class="color-title" [ngClass]="item">{{ item }}</h5>
          </ng-template>
        </ng-select>
      </mdc-form-field>
    </div>

    <div class="df-card__supporting-text df-card--border deck-color-selector">
      <mdc-form-field fluid>
        <ng-select
          appendTo="body"
          [items]="webSafeColours$ | async"
          placeholder="Colour"
          required
          formControlName="colour"
        >
          <ng-template
            ng-option-tmp
            let-item="item"
            let-index="index"
            let-search="searchTerm"
          >
            <h5 class="color-title" [ngClass]="item">{{ item }}</h5>
          </ng-template>
        </ng-select>
      </mdc-form-field>
    </div>

    <div class="df-card__supporting-text df-card--border deck-color-selector">
      <mdc-form-field fluid>
        <ng-select
          appendTo="body"
          [items]="eligibleParents"
          placeholder="Parent"
          bindLabel="title"
          bindValue="id"
          formControlName="parent"
        >
          <ng-template
            ng-option-tmp
            let-item="item"
            let-index="index"
            let-search="searchTerm"
          >
            <h5 class="color-title" [ngClass]="item">{{ item.title }}</h5>
          </ng-template>
        </ng-select>
      </mdc-form-field>
    </div>

    <div *ngIf="!showEditData && !showViewData" class="df-card__supporting-text df-card--border">
      <mdc-form-field>
        <ngx-wig
          formControlName="supportingText"
          [placeholder]="'Enter supporting text here.'"
        ></ngx-wig>
      </mdc-form-field>
    </div>

    <div *ngIf="showBriefList" class="df-card__supporting-text df-card--border deck-color-selector">
      <mdc-form-field fluid>
        <ng-select
          appendTo="body"
          [items]="briefs"
          bindLabel="name"
          placeholder="Select Brief"
          [multiple] ="true"
          (change) = "handleChangeBrief($event)"
          [clearable]="false"
          [hideSelected]="true"
          [virtualScroll]="true"
          formControlName="selectedBriefs"
        >
          <ng-template
            ng-option-tmp
            let-item="item"
            let-index="index"
            let-search="searchTerm"
          >
            <h5 class="color-title" [ngClass]="item">{{ item.name }}</h5>
          </ng-template>
        </ng-select>
      </mdc-form-field>
    </div>

    <div *ngIf="showEditData" class="df-card__supporting-text df-card--border">
      <mdc-form-field fluid>
        <mdc-textarea label="Data" formControlName="data" rows="5"></mdc-textarea>
      </mdc-form-field>
    </div>

    <div *ngIf="showViewData" class="df-card__supporting-text df-card--border">
        <input type="hidden" formControlName="data" />

        <pre>{{briefdata | json}}</pre>
    </div>

    <div
      formGroupName="media"
      *ngIf="showEditMedia"
      class="df-card__title"
    >
      <mdc-text-field
        type="url"
        required
        label="Media web address"
        formControlName="url"
      ></mdc-text-field>
    </div>
    <mdc-card outlined formArrayName="actions" class="df-card__actions-edit">
      <div class="df-card__actions-heading" mdcSubtitle2>Actions</div>
      <ng-container
        *ngFor="let actionEditor of actions.controls; let actionIndex = index"
        [formGroupName]="actionIndex"
      >
        <mdc-list-divider></mdc-list-divider>
        <mdc-ripple class="df-card__actions-content">
          <mdc-form-field fluid class="">
            <mdc-text-field
              label="Title"
              formControlName="title"
            ></mdc-text-field>
          </mdc-form-field>
          <mdc-form-field fluid>
            <mdc-text-field
              label="Url"
              type="url"
              formControlName="url"
            ></mdc-text-field>
          </mdc-form-field>
          <a
            mdc-button
            dense
            (click)="handleRemoveAction(actionIndex, actions[actionIndex])"
            >Delete</a
          >
        </mdc-ripple>
      </ng-container>
      <mdc-list-divider></mdc-list-divider>
      <div class="df-card__actions-footer">
        <a mdc-button dense (click)="handleAddAction()">
          Add Action
        </a>
      </div>
    </mdc-card>
    <div class="df-layout-spacer"></div>
    <div class="df-card__actions df-card--border">
      <button mdc-button dense (click)="handleCancelEditCard(card)">
        Cancel
      </button>
      <button mdc-button dense type="submit" [disabled]="!cardForm.valid">
        Save
      </button>
    </div>
  </form>
</ng-template>

<ng-template #cardActions let-card>
  <div
    class="df-card__actions df-card--border"
    *ngIf="
      card?.cardType == cardType.Parent ||
      card?.actions?.length > 0 ||
      card?.hasChildren
    "
  >
    <a
      *ngFor="let action of card?.actions"
      mdc-button
      dense
      (click)="onAction.emit(action)"
      >{{ action.title }}</a
    >
    <a
      *ngIf="card?.cardType == cardType.Parent || card?.hasChildren"
      (click)="onAction.emit(card)"
      mdc-button
      dense
      >More</a
    >
    <div class="df-layout-spacer"></div>
  </div>
</ng-template>
<ng-template #cardMenu let-card>
  <div
    *ngIf="!readOnly && !selectedCard"
    class="df-card__menu {{ card?.colour }} transparent"
  >
    <a
      (click)="cardEdit.next({ currentCard: card })"
      mdc-icon-button
      dense
      icon="edit"
    ></a>
  </div>
</ng-template>

<ng-template #cardTitle let-card>
  <div class="df-card__title {{ card?.colour }}" (click)="navigate(card)">
    <h2 class="df-card__title-text">{{ card?.title }}</h2>
  </div>
</ng-template>

<ng-template #cardSupportingText let-card>
  <div
    *ngIf="card?.supportingText"
    class="df-card__supporting-text"
    [innerHtml]="card?.supportingText"
  ></div>
</ng-template>

<ng-template #cardData let-card>
  <div *ngIf="card?.data" [innerHtml]="card?.data"></div>
</ng-template>

<ng-template #standardCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #embedCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardData; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #imageCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <div class="df-card__media" (click)="navigate(card)">
    <img class="deck-image" src="{{ card?.media?.url }}" border="0" alt="" />
  </div>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #parentCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #audioCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <audio name="media" controls style="width: 100%">
    <source [attr.src]="card?.media?.url" [attr.type]="card?.media?.type" />
    Your browser does not support the audio tag.
  </audio>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #videoCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <video controls>
    <source [attr.src]="card?.media?.url" />
    Your browser does not support the video tag.
  </video>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #markdownCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #refinerCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<ng-template #chartCard let-card>
  <ng-container
    *ngTemplateOutlet="cardTitle; context: { $implicit: card }"
  ></ng-container>
  <canvas
    baseChart
    width="400"
    height="400"
    [datasets]="card?.data?.chartData"
    [labels]="card?.data?.chartLabels"
    [options]="card?.data?.chartOptions"
    [colors]="card?.data?.chartColors"
    [legend]="card?.data?.chartLegend"
    [chartType]="card?.data?.chartType"
  ></canvas>
  <ng-container
    *ngTemplateOutlet="cardSupportingText; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardActions; context: { $implicit: card }"
  ></ng-container>
  <ng-container
    *ngTemplateOutlet="cardMenu; context: { $implicit: card }"
  ></ng-container>
</ng-template>

<section class="deck df-grid section--center">
  <ng-container *ngFor="let card of cards">
    <div
      *ngIf="selectedCard?.id === card.id"
      class="df-card df-cell df-cell--{{ card?.size }}-col df-shadow--4dp"
    >
      <ng-container
        *ngTemplateOutlet="editCard; context: { $implicit: selectedCard }"
      ></ng-container>
    </div>

    <div
      *ngIf="selectedCard?.id !== card.id"
      [ngSwitch]="card.cardType"
      class="df-card df-cell df-cell--{{ card?.size }}-col df-shadow--4dp"
    >
      <ng-container *ngSwitchCase="cardType.Image">
        <ng-container
          *ngTemplateOutlet="imageCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Parent">
        <ng-container
          *ngTemplateOutlet="parentCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Chart">
        <ng-container
          *ngTemplateOutlet="chartCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Markdown">
        <ng-container
          *ngTemplateOutlet="markdownCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Embed">
        <ng-container
          *ngTemplateOutlet="embedCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Audio">
        <ng-container
          *ngTemplateOutlet="audioCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Video">
        <ng-container
          *ngTemplateOutlet="videoCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="cardType.Refiner">
        <ng-container
          *ngTemplateOutlet="refinerCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
      <ng-container *ngSwitchDefault>
        <ng-container
          *ngTemplateOutlet="standardCard; context: { $implicit: card }"
        ></ng-container>
      </ng-container>
    </div>
  </ng-container>
  <div *ngIf="!selectedCard && !readOnly" class="df-card__supporting-text">
    <button mdc-button dense (click)="handleAddNewCard()">
      Create New Card
    </button>
  </div>
</section>
